webpackJsonp([11],{Thr3:function(e,t){},"gn/k":function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=a("fZjL"),n=a.n(r),o=a("mvHQ"),s=a.n(o),i=a("BO1k"),u=a.n(i),c=a("Xxa5"),l=a.n(c),d=a("exGp"),f=a.n(d),v=a("g7ZD"),p=a("RwfU"),b=a("mtWM"),m=a.n(b),h=a("Er6Z"),g={name:"dataForm",props:{form_id:{type:Number,default:-1},is_add:{type:Boolean,default:!0}},created:function(){var e=this;v.a.$on("showDataForm",function(t,a){e.record_id=a,e.formData=t,e.oldData=[];var r=!0,n=!1,o=void 0;try{for(var i,c=u()(t);!(r=(i=c.next()).done);r=!0){var l=i.value;e.oldData.push(JSON.parse(s()(l)))}}catch(e){n=!0,o=e}finally{try{!r&&c.return&&c.return()}finally{if(n)throw o}}e.dialogVisible=!0})},data:function(){return{fileList:[],record_id:-1,dialogVisible:!1,toolBarConfig:{slots:{buttons:"toolbar_buttons"}},formData:[],oldData:[],dataValidRules:{value:[{required:!0,message:"数据必填",trigger:"blur"}]}}},methods:{uploadFileEvent:function(e){var t=this;this.oldData[this.oldData.length-1].value="无附件",this.$refs.dataForm.readFile({multiple:!1,types:["xlsx","csv","pdf","txt","rar","jpg"],message:!0}).then(function(a){var r=a.files;t.fileList=r,e.value=r[0].name})},closeEvent:function(){this.dialogVisible=!1,this.$refs.dataForm.reloadData([])},save:function(){this.is_add?this.add():this.edit()},add:function(){var e=this;return f()(l.a.mark(function t(){var a,r,n,o,s,i,c,d;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.$refs.dataForm.validate(!0).catch(function(e){return e});case 2:if(!t.sent){t.next=5;break}return t.abrupt("return");case 5:for(t.prev=5,a=e.getInsertData(e.formData),r=a.filter(function(e){return""===e.value}),n=!0,o=!1,s=void 0,t.prev=11,i=u()(r);!(n=(c=i.next()).done);n=!0)c.value.value=!1;t.next=19;break;case 15:t.prev=15,t.t0=t.catch(11),o=!0,s=t.t0;case 19:t.prev=19,t.prev=20,!n&&i.return&&i.return();case 22:if(t.prev=22,!o){t.next=25;break}throw s;case 25:return t.finish(22);case 26:return t.finish(19);case 27:return t.next=29,e.$http.post("api/data/add",{form_id:e.form_id,insert:a});case 29:return d=t.sent,t.next=32,e.submitFile();case 32:if(200===d.data.code){t.next=36;break}Object(h.a)(d.data),t.next=41;break;case 36:return t.next=38,e.submitFile();case 38:e.$message.success("添加成功"),v.a.$emit("refreshTable"),e.closeEvent();case 41:t.next=46;break;case 43:t.prev=43,t.t1=t.catch(5),Object(p.a)(t.t1);case 46:case"end":return t.stop()}},t,e,[[5,43],[11,15,19,27],[20,,22,26]])}))()},edit:function(){var e=this;return f()(l.a.mark(function t(){var a,r,n;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.$refs.dataForm.validate(!0).catch(function(e){return e});case 2:if(a=t.sent,console.log(a),!a){t.next=6;break}return t.abrupt("return");case 6:return t.prev=6,r=e.getUpdateData(e.formData,e.oldData),t.next=10,e.$http.post("api/data/edit",{form_id:e.form_id,record_id:e.record_id,update:r});case 10:if(200===(n=t.sent).data.code){t.next=15;break}Object(h.a)(n.data),t.next=20;break;case 15:return t.next=17,e.submitFile();case 17:e.$message.success("修改成功"),v.a.$emit("refreshTable"),e.closeEvent();case 20:t.next=25;break;case 22:t.prev=22,t.t0=t.catch(6),Object(p.a)(t.t0);case 25:case"end":return t.stop()}},t,e,[[6,22]])}))()},getUpdateData:function(e,t){var a=n()(t),r=[],o=!0,s=!1,i=void 0;try{for(var c,l=u()(a);!(o=(c=l.next()).done);o=!0){var d=c.value;e[d].value!==t[d].value&&r.push({col_name:e[d].field,value:e[d].value})}}catch(e){s=!0,i=e}finally{try{!o&&l.return&&l.return()}finally{if(s)throw i}}return r},submitFile:function(){var e=this;return f()(l.a.mark(function t(){var a,r;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==e.fileList.length){t.next=2;break}return t.abrupt("return");case 2:return t.prev=2,(a=new FormData).append("file",e.fileList[0]),t.next=7,e.$http.post("api/file/add",a,{headers:{"Content-Type":"multipart/form-data"}});case 7:200!==(r=t.sent).data.code?Object(h.a)(r.data):v.a.$emit("refreshTable"),t.next=14;break;case 11:t.prev=11,t.t0=t.catch(2),Object(p.a)(t.t0);case 14:case"end":return t.stop()}},t,e,[[2,11]])}))()},getInsertData:function(e){var t=[],a=!0,r=!1,n=void 0;try{for(var o,s=u()(e);!(a=(o=s.next()).done);a=!0){var i=o.value;t.push({col_name:i.field,value:i.value})}}catch(e){r=!0,n=e}finally{try{!a&&s.return&&s.return()}finally{if(r)throw n}}return t}}},x={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-dialog",{staticStyle:{height:"100%"},attrs:{"close-on-click-modal":!1,"modal-append-to-body":!1,"append-to-body":"",visible:e.dialogVisible,"before-close":e.closeEvent},on:{"update:visible":function(t){e.dialogVisible=t}}},[a("vxe-table",{ref:"dataForm",attrs:{border:"",resizable:"","keep-source":"","edit-rules":e.dataValidRules,"edit-config":{trigger:"click",mode:"cell"},data:e.formData}},[a("vxe-column",{attrs:{field:"title",title:"数据表字段名称","edit-render":{}},scopedSlots:e._u([{key:"default",fn:function(t){var r=t.row;return[a("span",[e._v(e._s(r.title))])]}},{key:"edit",fn:function(t){var r=t.row;return[a("span",[e._v(e._s(r.title))])]}}])}),e._v(" "),a("vxe-column",{attrs:{field:"value",title:"数据","edit-render":{}},scopedSlots:e._u([{key:"default",fn:function(t){var r=t.row;return["bool"===r.data_type?a("vxe-switch",{attrs:{"open-label":"是","close-label":"否","close-value":!1},model:{value:r.value,callback:function(t){e.$set(r,"value",t)},expression:"row.value"}}):a("div",[a("span",[e._v(e._s(r.value))]),e._v(" "),"file"===r.field?a("vxe-button",{attrs:{status:"primary"},on:{click:function(t){return e.uploadFileEvent(r)}}},[e._v("上传附件")]):e._e()],1)]}},{key:"edit",fn:function(t){var r=t.row;return["bool"===r.data_type?a("vxe-switch",{attrs:{"open-label":"是","close-label":"否"},model:{value:r.value,callback:function(t){e.$set(r,"value",t)},expression:"row.value"}}):"file"===r.field?a("div",[a("span",[e._v(e._s(r.value))]),e._v(" "),"file"===r.field?a("vxe-button",{staticStyle:{right:"0"},attrs:{status:"primary"},on:{click:function(t){return e.uploadFileEvent(r)}}},[e._v("\n            上传附件\n          ")]):e._e()],1):"time"===r.data_type||"date"===r.data_type||"datetime"===r.data_type?a("vxe-input",{attrs:{type:r.data_type},model:{value:r.value,callback:function(t){e.$set(r,"value",t)},expression:"row.value"}}):a("vxe-input",{attrs:{type:"text"},model:{value:r.value,callback:function(t){e.$set(r,"value",t)},expression:"row.value"}})]}}])})],1),e._v(" "),a("div",{staticStyle:{"margin-top":"10px"}},[a("span",{staticStyle:{margin:"auto"}},[a("el-button",{on:{click:e.closeEvent}},[e._v("取 消")]),e._v(" "),a("el-button",{attrs:{type:"primary"},on:{click:e.save}},[e._v("确 定")])],1)])],1)},staticRenderFns:[]};var _={name:"dataList",components:{DataForm:a("VU/8")(g,x,!1,function(e){a("Thr3")},"data-v-637e45be",null).exports},data:function(){return{len:3,showMore:!1,toolBarConfig:{slots:{buttons:"toolbar_buttons"}},is_add:!0,tablePage:{currentPage:1,pageSize:10},tableColumn:[],tableData:[],currentData:[],queryForm:{}}},created:function(){var e=this;this.getTableColumn(this.$route.query.form_id),v.a.$on("refreshTable",function(){e.getTableData(e.$route.query.form_id)})},watch:{"$route.query.form_id":{handler:function(e){this.getTableColumn(e)}}},methods:{showMoreFunc:function(){this.showMore=!this.showMore,this.showMore?this.len=this.tableColumn.length:this.len=3},getTableColumn:function(e){var t=this;return f()(l.a.mark(function a(){var r;return l.a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(-1!==e&&void 0!==e){a.next=2;break}return a.abrupt("return");case 2:return a.prev=2,a.next=5,t.$http.get("api/data/column",{params:{form_id:e}});case 5:if(200===(r=a.sent).data.code){a.next=10;break}Object(h.a)(r.data),a.next=14;break;case 10:return t.tableColumn=r.data.data,t.tableColumn.push({field:"file",title:"附件",value:"无附件"}),a.next=14,t.getTableData(e);case 14:a.next=19;break;case 16:a.prev=16,a.t0=a.catch(2),Object(p.a)(a.t0.message);case 19:case"end":return a.stop()}},a,t,[[2,16]])}))()},getTableData:function(e){var t=this;return f()(l.a.mark(function a(){var r;return l.a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,t.$http.post("api/data/query",{form_id:e,columns:t.getQueryList()});case 3:200!==(r=a.sent).data.code?Object(h.a)(r.data):(t.tableData=r.data.data,t.page()),a.next=10;break;case 7:a.prev=7,a.t0=a.catch(0),Object(p.a)(a.t0.message);case 10:case"end":return a.stop()}},a,t,[[0,7]])}))()},addEvent:function(){var e=this;return f()(l.a.mark(function t(){var a,r,n,o,i,c,d,f,p,b;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=e.$cookies.get("login_cookie"),r="",a&&(r=a.split("_")[1]),t.next=5,e.$http.post("api/auth/check",{user:r,option:"addAuth",form_id:e.$route.query.form_id});case 5:if(200===(n=t.sent).data.code){t.next=8;break}return t.abrupt("return",Object(h.a)(n.data));case 8:for(e.is_add=!0,o=[],i=!0,c=!1,d=void 0,t.prev=13,f=u()(e.tableColumn);!(i=(p=f.next()).done);i=!0)"bool"===(b=p.value).data_type&&(b.value=!1),o.push(JSON.parse(s()(b)));t.next=21;break;case 17:t.prev=17,t.t0=t.catch(13),c=!0,d=t.t0;case 21:t.prev=21,t.prev=22,!i&&f.return&&f.return();case 24:if(t.prev=24,!c){t.next=27;break}throw d;case 27:return t.finish(24);case 28:return t.finish(21);case 29:console.log(o),v.a.$emit("showDataForm",o,-1);case 31:case"end":return t.stop()}},t,e,[[13,17,21,29],[22,,24,28]])}))()},handlePageChange:function(e){var t=e.currentPage,a=e.pageSize;this.tablePage.currentPage=t,this.tablePage.pageSize=a,this.currentData=this.tableData.slice((t-1)*a,a*t)},removeEvent:function(){var e=this;return f()(l.a.mark(function t(){var a,r;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a=e.$refs.dataTable.getCurrentRecord()){t.next=3;break}return t.abrupt("return",Object(p.a)("请先选择需要删除的数据"));case 3:return t.next=5,e.$http.post("api/auth/check",{user:a.user,option:"del",form_id:e.$route.query.form_id});case 5:if(200===(r=t.sent).data.code){t.next=8;break}return t.abrupt("return",Object(h.a)(r.data));case 8:e.$confirm("此操作将永久删除该文件, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(f()(l.a.mark(function t(){var a,r;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=e.$refs.dataTable.getCurrentRecord(),t.next=4,m.a.post("api/data/delete",{record_id:a.record_id,form_id:e.$route.query.form_id});case 4:if(200===(r=t.sent).data.code){t.next=9;break}Object(h.a)(r.data.msg),t.next=12;break;case 9:return t.next=11,e.getTableData(e.$route.query.form_id);case 11:e.page();case 12:t.next=17;break;case 14:t.prev=14,t.t0=t.catch(0),Object(p.a)(t.t0.message);case 17:case"end":return t.stop()}},t,e,[[0,14]])}))).catch(function(){e.$message({type:"info",message:"已取消删除"})});case 9:case"end":return t.stop()}},t,e)}))()},editEvent:function(){var e=this;return f()(l.a.mark(function t(){var a,r,n;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a=e.$refs.dataTable.getCurrentRecord()){t.next=3;break}return t.abrupt("return",Object(p.a)("请先选择需要修改的数据"));case 3:return r=e.$cookies.get("login_cookie"),"",r&&r.split("_")[1],t.next=8,e.$http.post("api/auth/check",{user:a.user,option:"editAuth",form_id:e.$route.query.form_id});case 8:if(200===(n=t.sent).data.code){t.next=11;break}return t.abrupt("return",Object(h.a)(n.data));case 11:e.is_add=!1,v.a.$emit("showDataForm",e.getEditData(a),a.record_id);case 13:case"end":return t.stop()}},t,e)}))()},page:function(){var e=this.tablePage.pageSize;this.currentData=this.tableData.slice(0,e)},getEditData:function(e){var t=[],a=!0,r=!1,o=void 0;try{for(var i,c=u()(this.tableColumn);!(a=(i=c.next()).done);a=!0){var l=i.value;t.push(JSON.parse(s()(l)))}}catch(e){r=!0,o=e}finally{try{!a&&c.return&&c.return()}finally{if(r)throw o}}for(var d=n()(e),f=0;f<t.length;f++){var v=!0,p=!1,b=void 0;try{for(var m,h=u()(d);!(v=(m=h.next()).done);v=!0){var g=m.value;t[f].field===g&&(t[f].value=e[g])}}catch(e){p=!0,b=e}finally{try{!v&&h.return&&h.return()}finally{if(p)throw b}}}return t},getQueryList:function(){var e=[],t=n()(this.queryForm),a=!0,r=!1,o=void 0;try{for(var s,i=u()(t);!(a=(s=i.next()).done);a=!0){var c=s.value;""!==this.queryForm[c]&&null!==this.queryForm[c]&&void 0!==this.queryForm[c]&&e.push({col_name:c,value:this.queryForm[c]})}}catch(e){r=!0,o=e}finally{try{!a&&i.return&&i.return()}finally{if(r)throw o}}return e},resetForm:function(){this.$refs.queryForm.resetFields(),this.$message.success("查询表单已重置")},downloadFile:function(){var e=this;return f()(l.a.mark(function t(){var a,r,n,o,s;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a=e.$refs.dataTable.getCurrentRecord()){t.next=3;break}return t.abrupt("return",Object(p.a)("请先选择需要下载的附件"));case 3:if("无附件"!==a.file){t.next=5;break}return t.abrupt("return",Object(p.a)("没有可以下载的附件"));case 5:return t.prev=5,t.next=8,e.$http.post("api/file/download",{file_name:a.file},{responseType:"blob"});case 8:r=t.sent,n=new Blob([r.data]),o=a.file,"download"in document.createElement("a")?((s=document.createElement("a")).download=o,s.style.display="none",s.href=URL.createObjectURL(n),document.body.appendChild(s),s.click(),URL.revokeObjectURL(s.href),document.body.removeChild(s)):window.navigator.msSaveBlob(n,o),t.next=18;break;case 14:t.prev=14,t.t0=t.catch(5),console.log(t.t0),Object(p.a)("下载文件失败，请稍后再试。");case 18:case"end":return t.stop()}},t,e,[[5,14]])}))()}}},y={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"list-body"},[a("el-row",[a("el-form",{ref:"queryForm",attrs:{model:e.queryForm,"label-width":"80px",size:"small"}},e._l(e.tableColumn.slice(0,e.len),function(t,r){return a("el-col",{key:r,attrs:{span:8}},[a("el-form-item",{attrs:{prop:t.field,label:t.title}},[a("el-input",{attrs:{clearable:""},model:{value:e.queryForm[t.field],callback:function(a){e.$set(e.queryForm,t.field,a)},expression:"queryForm[item.field]"}})],1)],1)}),1)],1),e._v(" "),a("vxe-grid",{ref:"dataTable",staticClass:"dataList",attrs:{border:"",resizable:"","toolbar-config":e.toolBarConfig,"row-config":{isCurrent:!0},columns:e.tableColumn,data:e.currentData},scopedSlots:e._u([{key:"toolbar_buttons",fn:function(){return[a("div",{staticStyle:{"text-align":"right"}},[a("span",{staticStyle:{"margin-right":"20px"}},[a("vxe-button",{attrs:{status:"primary"},on:{click:function(t){return e.getTableData(e.$route.query.form_id)}}},[e._v("查询")]),e._v(" "),a("vxe-button",{on:{click:e.resetForm}},[e._v("重置")]),e._v(" "),e.showMore?a("el-button",{attrs:{type:"text"},on:{click:e.showMoreFunc}},[a("i",{staticClass:"el-icon-arrow-up"}),e._v("收起")]):a("el-button",{attrs:{type:"text"},on:{click:e.showMoreFunc}},[a("i",{staticClass:"el-icon-arrow-down"}),e._v("展开")])],1),e._v(" "),a("vxe-button",{attrs:{status:"success"},on:{click:e.addEvent}},[e._v("新增")]),e._v(" "),a("vxe-button",{attrs:{status:"success"},on:{click:e.editEvent}},[e._v("修改")]),e._v(" "),a("vxe-button",{attrs:{status:"success"},on:{click:e.removeEvent}},[e._v("删除")]),e._v(" "),a("vxe-button",{attrs:{status:"success"},on:{click:e.downloadFile}},[e._v("下载附件")]),e._v(" "),a("vxe-button",{on:{click:function(t){return e.$refs.dataTable.exportData()}}},[e._v("导出")])],1)]},proxy:!0},{key:"pager",fn:function(){return[a("vxe-pager",{attrs:{layouts:["Sizes","PrevJump","PrevPage","Number","NextPage","NextJump","FullJump","Total"],"current-page":e.tablePage.currentPage,"page-size":e.tablePage.pageSize,total:e.tableData.length},on:{"update:currentPage":function(t){return e.$set(e.tablePage,"currentPage",t)},"update:current-page":function(t){return e.$set(e.tablePage,"currentPage",t)},"update:pageSize":function(t){return e.$set(e.tablePage,"pageSize",t)},"update:page-size":function(t){return e.$set(e.tablePage,"pageSize",t)},"page-change":e.handlePageChange}})]},proxy:!0}])}),e._v(" "),a("data-form",{staticClass:"data-form",attrs:{is_add:e.is_add,form_id:Number(e.$route.query.form_id)}})],1)},staticRenderFns:[]};var k=a("VU/8")(_,y,!1,function(e){a("hLgM")},"data-v-2615972c",null);t.default=k.exports},hLgM:function(e,t){}});
//# sourceMappingURL=11.c4459b97d14fbdc8ebba.js.map